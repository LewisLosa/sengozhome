# inspired: https://github.com/eh8/chenglab/blob/main/.github/workflows/release.yml
name: "Release custom NixOS ISO"

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest
    outputs:
      iso-name: ${{ steps.rename.outputs.iso-name }}
      iso-hash: ${{ steps.hash.outputs.sha256 }}
    steps:
      - name: Check free space
        run: |
          echo "Free space:"
          df -h

      # inspired: https://carlosbecker.com/posts/github-actions-disk-space/
      - name: Clean the battlefield ðŸ§¹âš”ï¸
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo docker builder prune -a -f

      - name: Check free space after cleanup
        run: |
          echo "Free space after cleanup:"
          df -h

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install nix-chan~!!
        uses: cachix/install-nix-action@v30

      - name: Forge the ISO âš’ï¸ðŸ”¥
        working-directory: nix-conf
        run: |
          nix_bin=$(which nix)
          sudo $nix_bin build .#nixosConfigurations.isochan.config.system.build.isoImage

      - name: Check ISO location ðŸ”
        run: |
          echo "Looking for ISO files..."
          find . -name "*.iso" -type f 2>/dev/null || true
          echo "Checking nix-conf/result..."
          ls -la nix-conf/result/ 2>/dev/null || echo "nix-conf/result not found"
          ls -la nix-conf/result/iso/ 2>/dev/null || echo "nix-conf/result/iso not found"

      - name: A little salt is added (renaming) ðŸ·ï¸ðŸŒ¸
        id: rename
        run: |
          short_sha=$(git rev-parse --short HEAD)
          iso_name="nixos-${GITHUB_REF_NAME}-${short_sha}.iso"
          
          # ISO dosyasÄ±nÄ± nix-conf dizininden bul ve taÅŸÄ±
          iso_file=$(find nix-conf/result/iso -name "nixos-*.iso" -type f | head -n 1)
          
          if [ -z "$iso_file" ]; then
            echo "Error: ISO file not found!"
            exit 1
          fi
          
          echo "Found ISO: $iso_file"
          sudo mv "$iso_file" "$iso_name"
          echo "iso-name=$iso_name" >> $GITHUB_OUTPUT

      - name: Sha256 checksum
        id: hash
        run: |
          iso_name="${{ steps.rename.outputs.iso-name }}"
          sha256sum "$iso_name" > "${iso_name}.sha256"
          hash=$(sha256sum "$iso_name" | awk '{print $1}')
          echo "sha256=$hash" >> $GITHUB_OUTPUT
          echo "SHA256: $hash"

      - name: Send ISO to the guild ðŸ“¤ðŸŒ¸
        uses: actions/upload-artifact@v4
        with:
          name: nixos-iso
          path: |
            nixos-*.iso
            nixos-*.iso.sha256
          retention-days: 7

  release:
    needs: build-iso
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Retrieve the sacred ISO ðŸ“¥âœ¨
        uses: actions/download-artifact@v4
        with:
          name: nixos-iso
          path: .

      - name: Create release notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸŒ¸âœ¨ hey there! its new iso release :3 âœ¨ðŸŒ¸
          **iso:** ${{ needs.build-iso.outputs.iso-name }}
          **sha256:** `${{ needs.build-iso.outputs.iso-hash }}`
          EOF

      - name: Release the episode ðŸŽ¬ðŸš€
        uses: softprops/action-gh-release@v2
        with:
          files: |
            nixos-*.iso
            nixos-*.iso.sha256
          body_path: release_notes.md
          draft: false
          prerelease: false